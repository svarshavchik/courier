<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<!-- Copyright 1998 - 2009 S. Varshavchik.  See COPYING for -->
<!-- distribution information. -->
<refentry id="makehosteddomains">
  <info><author><firstname>Sam</firstname><surname>Varshavchik</surname><contrib>Author</contrib></author><productname>Courier Mail Server</productname></info>

  <refmeta>
    <refentrytitle>makehosteddomains</refentrytitle>
    <manvolnum>8</manvolnum>
    <refmiscinfo>S. Varshavchik.</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname>makehosteddomains</refname>
    <refpurpose>Build a database of hosted domains</refpurpose>
  </refnamediv>

  <refsynopsisdiv>
    <cmdsynopsis sepchar=" ">
      <command>makehosteddomains</command>
    </cmdsynopsis>
  </refsynopsisdiv>

  <refsect1 id="makehosteddomains_description">
    <title>DESCRIPTION</title>

    <para>
<command>makehosteddomains</command> rebuilds the contents of the
<filename>@sysconfdir@/hosteddomains.dat</filename> database from the
contents of <filename>@sysconfdir@/hosteddomains</filename>.
This can be either a file or a
directory.  If it's a directory, the contents of all the files in this
directory are simply concatenated.
The <command>makehosteddomains</command> script
must be run in order for any changes to
<filename>@sysconfdir@/hosteddomains</filename> to take effect.</para>

    <para>
The function of <filename>@sysconfdir@/hosteddomains</filename> is very
similar to the one of <filename>@sysconfdir@/locals</filename>.
Both configuration files specify
a list of domains that are considered to be local domains - domains whose
mailboxes are stored locally.</para>

    <para>
The difference is that domains listed in <filename>@sysconfdir@/locals</filename>
are removed from addresses before their mailbox is looked up. For example, if
the domain "<literal>example.com</literal>" is listed in <filename>@sysconfdir@/locals</filename>,
then the address <filename>&lt;user@example.com&gt;</filename> is delivered to a local
mailbox named "<literal>user</literal>".  If this domain is listed, instead, in
<filename>@sysconfdir@/hosteddomains</filename>, then the address
<literal>&lt;user@example.com&gt;</literal> is delivered to a local mailbox named
"<literal>user@example.com</literal>". Usually you would use
<filename>@sysconfdir@/locals</filename> to specify domains that correspond to your
local system accounts, that are looked up in your system's password database.
The <filename>@sysconfdir@/hosteddomains</filename> file is usually used when you have
database-based virtual domains, that are maintained via an LDAP or a MySQL
server.
The <application>Courier</application> mail server's LDAP and MySQL
authentication modules will use the full
E-mail address to query the LDAP or MySQL server for the location of the local
mailbox that correspond to the E-mail address.
The <application>Courier</application> mail server's
<literal>authuserdb</literal> authentication module can also use full E-mail
addresses.</para>

    <refsect2 id="makehosteddomains_contents_of_hosteddomains">
      <title>Contents of <filename>hosteddomains</filename></title>

      <para>
The file <filename>@sysconfdir@/hosteddomains</filename>
simply contains a list of domains, one per line, for example:</para>

      <informalexample>
	<programlisting format="linespecific">
domain.com
example.org
</programlisting>
      </informalexample>

      <para>
Each domain can optionally be followed by a single tab character, in order
to specify an alias for a domain, for example:</para>

      <informalexample>
	<programlisting format="linespecific">
domain.com
mail.domain.com&lt;TAB&gt;domain.com
example.com&lt;TAB&gt;domain.com
</programlisting>
      </informalexample>

      <para>
First, we list the domain "<literal>domain.com</literal>" as a hosted domain.
Then, we also list the domain "<literal>mail.domain.com</literal>", which is
an alias for
<literal>domain.com</literal>.
The <application>Courier</application> mail server will take any
address of the form
<literal>&lt;address@mail.domain.com&gt;</literal>, rewrite it as
<literal>&lt;address@domain.com&gt;</literal>, and attempt to deliver the
mail to a local mailbox for that name.
The third entry does the same for "<literal>example.com</literal>"; mail
addressed to
<literal>&lt;address@example.com&gt;</literal> is delivered to the local
mailbox <literal>&lt;address@domain.com&gt;</literal>.</para>
    </refsect2>

    <refsect2 id="makehosteddomains_alias_hosteddomain">
      <title><literal>alias@hosteddomain</literal></title>

      <para>
This is a special local mail delivery rule for
<filename>hosteddomain</filename>-listed
domains. This rule allows the <application>Courier</application>
mail server accept mail to any
<literal>address@hosteddomain</literal>, where "hosteddomain" is a domain listed in the
<literal>hosteddomains</literal> file, but there is no corresponding account for
<literal>address@hosteddomain</literal>. To provide delivery instructions for any
non-existing address in a <filename>hosteddomain</filename>-listed
domain:</para>

      <para>
1) Create the local address <literal>alias@hosteddomain</literal>.  For example, if the
<filename>hosteddomains</filename> file contains "example.com", create the local
account <literal>alias@example.com</literal>.  This should be a normal account, with its
own home directory, userid and groupid.</para>

      <para>
2) Create <filename>$HOME/.courier-default</filename> file in this account,
containing the delivery instructions. See the
<ulink url="dot-courier.html"><citerefentry><refentrytitle>dot-courier</refentrytitle><manvolnum>5</manvolnum></citerefentry></ulink>
manual page for available delivery instructions.</para>

      <para>
NOTE that <literal>alias@example.com</literal> must be a real account, not a mail
alias. If you want to forward <literal>alias@example.com</literal> to another address, put
forwarding instructions in the <filename>.courier-default</filename> file. However,
<literal>alias@example.com</literal> can be a clone of another account (with the same home
directory, userid, and groupid).</para>

    </refsect2>

    <refsect2 id="makehosteddomains_wildcard_dns">
      <title><quote>WILDCARD DNS</quote></title>

      <para>
Wildcard DNS is supported for hosteddomains by placing a single period
character before the domain name. For example, the hosted domain entry
<quote>.domain.com</quote>
will cause the <application>Courier</application>
mail server to accept mail for
<quote>anything.domain.com</quote>.</para>

      <para>
The <application>Courier</application> mail server will accept
mail for
&lt;<replaceable>address@any.thing.domain.com</replaceable>&gt;
and attempt
to deliver it to the local mailbox
&lt;<replaceable>address@any.thing.domain.com</replaceable>&gt;,
and if that fails then attempt to deliver the mail to the local
mailbox
&lt;<replaceable>address@.thing.domain.com</replaceable>&gt;,
then finally
&lt;<replaceable>address@.domain.com</replaceable>&gt;</para>

      <note>
	<para>
There is a period after the '@' character. If you want all mail
for
<quote>any.thing.domain.com</quote>
to be delivered as though it were sent to
<quote>domain.com</quote>,
you should define an alias for the domain, for example:
</para>

	<informalexample>
	  <programlisting format="linespecific">
domain.com
.domain.com&lt;TAB&gt;domain.com
</programlisting>
      </informalexample>
      </note>
    </refsect2>
  </refsect1>

  <refsect1 id="makehosteddomains_subdir">
    <title>Subdirectory checks</title>

    <para>
      <filename>@sysconfdir@/hosteddomains</filename>
      can be a subdirectory instead of
      a text file. This has the effect of concatenating all files in that
      directory (subject to the following checks) and then using the result
      as the
      <filename>@sysconfdir@/hosteddomains</filename>.
      The following checks are made:
    </para>

    <itemizedlist>
      <listitem>
	<para>
	  Files whose names contain a tilde, <quote>~</quote> are skipped over.
	</para>
      </listitem>

      <listitem>
	<para>
	  Files whose names end with the following suffixes result in an error
	  message: <quote>.rpmsave</quote>, <quote>.rpmnew</quote>, and
	  <quote>.dpkg-<replaceable>suffix</replaceable></quote>. These files
	  are backup files created by package manager when updating to a newer
	  version of the package and contain the old or the new version of a
	  configuration file whose settings may be new or obsolete.
	</para>
	<para>
	  The contents of the file whose name does not have the suffix should
	  be checked against the backup. The backup file should be deleted
	  after making any needed manual changes to the configuration file.
	</para>
      </listitem>

      <listitem>
	<para>
	  Files whose names end with the <quote>.dist</quote> suffix is also
	  treated as a configuration file backup or template, but with the
	  following exception: the <quote>.dist</quote> file gets ignored
	  and automatically skipped over, without any error message, if
	  the suffix-less file exists and its modification time is more recent
	  than the <quote>.dist</quote> file's modification time.
	</para>

	<para>
	  Otherwise an error message gets reported. Resolving the error
	  message is done by either copying the
	  <quote>.dist</quote> file or editing and saving the file without
	  the suffix (resulting in a newer timestamp).
	</para>
      </listitem>
    </itemizedlist>
  </refsect1>

  <refsect1 id="makehosteddomains_see_also">
    <title>SEE ALSO</title>
    <para>
<ulink url="esmtpd.html"><citerefentry><refentrytitle>esmtpd</refentrytitle><manvolnum>8</manvolnum></citerefentry></ulink>.</para>
  </refsect1>
</refentry>
