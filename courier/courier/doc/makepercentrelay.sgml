<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<!-- Copyright 1998 - 2009 S. Varshavchik.  See COPYING for -->
<!-- distribution information. -->
<refentry id="makepercentrelay">
  <info><author><firstname>Sam</firstname><surname>Varshavchik</surname><contrib>Author</contrib></author><productname>Courier Mail Server</productname></info>

  <refmeta>
    <refentrytitle>makepercentrelay</refentrytitle>
    <manvolnum>8</manvolnum>
    <refmiscinfo>S. Varshavchik.</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname>makepercentrelay</refname>
    <refpurpose>Build a list of %-relayed domains</refpurpose>
  </refnamediv>

  <refsynopsisdiv>
    <cmdsynopsis sepchar=" ">
      <command>makepercentrelay</command>
    </cmdsynopsis>
  </refsynopsisdiv>

  <refsect1 id="makepercentrelay_description">
    <title>DESCRIPTION</title>

    <para>
<command>makepercentrelay</command> reads
<filename>@sysconfdir@/esmtppercentrelay.dir</filename>
and creates <filename>@sysconfdir@/esmtppercentrelay.dat</filename> which is a
binary
database file. The files <filename>@sysconfdir@/esmtppercentrelay</filename>
and
<filename>@sysconfdir@/esmtppercentrelay.dat</filename> specify a list of
"percent-hack"
domains. <filename>@sysconfdir@/esmtppercentrelay</filename> is a plain text
file,
containing one domain per line.
The <application>Courier</application> mail server loads the
contents of
<filename>@sysconfdir@/esmtppercentrelay</filename> into memory, so if you
have a lot of
domains, you will want to use the binary database file.  The
<command>makepercentrelay</command> command reads
<filename>@sysconfdir@/esmtppercentrelay.dir</filename>, which can be either
a plain text
file itself, or a directory containing plain text files. All files in the
subdirectory are concatenated, and the binary database file is created from
the result.</para>

    <para>
the <application>Courier</application> mail server can use both <filename>@sysconfdir@/esmtppercentrelay</filename> and
<filename>@sysconfdir@/esmtppercentrelay.dat</filename> at the same time.
Usually you
would put a couple of your most frequent domains in
<filename>@sysconfdir@/esmtppercentrelay</filename>, then put the rest in
<filename>@sysconfdir@/esmtppercentrelay.dir</filename>, and use
<command>makepercentrelay</command> to turn it into a database file.</para>

    <para>
"percent-hack" domains are a list of domains for which the <application>Courier</application> mail server accepts mail
via ESMTP addressed as "local%percent.hack.domain@local.domain", where
"percent.hack.domain" is a domain found in
<filename>@sysconfdir@/esmtppercentrelay</filename> or
<filename>@sysconfdir@/esmtppercentrelay.dat</filename>, and
"<literal>local.domain</literal>" is any domain
found in <filename>@sysconfdir@/locals</filename>.
The <application>Courier</application> mail server removes the local
domain, and
rewrites the address as "<literal>local@percent.hack.domain</literal>", then
attempts to deliver it.</para>

    <para>
The percent hack applies only to mail received via ESMTP.
The <application>Courier</application> mail server does not
check this list of domains if the message is received via any other way (such
as by running <command>@bindir@/sendmail</command> directly from the command
line).
"<literal>percent.hack.domain</literal>" would likely to be a domain that
the <application>Courier</application> mail server
knows how to handle via some other means.  It might be an entry in
<filename>@sysconfdir@/aliases</filename>, or an entry in
<filename>@sysconfdir@/esmtproutes</filename>.</para>
  </refsect1>

  <refsect1 id="makepercentrelay_subdir">
    <title>Subdirectory checks</title>

    <para>
      The following checks are made on the contents of
      <filename>@sysconfdir@/esmtppercentrelay.dir</filename>:
    </para>

    <itemizedlist>
      <listitem>
	<para>
	  Files whose names contain a tilde, <quote>~</quote> are skipped over.
	</para>
      </listitem>

      <listitem>
	<para>
	  Files whose names end with the following suffixes result in an error
	  message: <quote>.rpmsave</quote>, <quote>.rpmnew</quote>, and
	  <quote>.dpkg-<replaceable>suffix</replaceable></quote>. These files
	  are backup files created by package manager when updating to a newer
	  version of the package and contain the old or the new version of a
	  configuration file whose settings may be new or obsolete.
	</para>
	<para>
	  The contents of the file whose name does not have the suffix should
	  be checked against the backup. The backup file should be deleted
	  after making any needed manual changes to the configuration file.
	</para>
      </listitem>

      <listitem>
	<para>
	  Files whose names end with the <quote>.dist</quote> suffix is also
	  treated as a configuration file backup or template, but with the
	  following exception: the <quote>.dist</quote> file gets ignored
	  and automatically skipped over, without any error message, if
	  the suffix-less file exists and its modification time is more recent
	  than the <quote>.dist</quote> file's modification time.
	</para>

	<para>
	  Otherwise an error message gets reported. Resolving the error
	  message is done by either copying the
	  <quote>.dist</quote> file or editing and saving the file without
	  the suffix (resulting in a newer timestamp).
	</para>
      </listitem>
    </itemizedlist>
  </refsect1>

  <refsect1 id="makepercentrelay_see_also">
    <title>SEE ALSO</title>
    <para>
<ulink url="esmtpd.html"><citerefentry><refentrytitle>esmtpd</refentrytitle><manvolnum>8</manvolnum></citerefentry></ulink>,
<ulink url="makealiases.html"><citerefentry><refentrytitle>makealiases</refentrytitle><manvolnum>8</manvolnum></citerefentry></ulink>.</para>
  </refsect1>
</refentry>
